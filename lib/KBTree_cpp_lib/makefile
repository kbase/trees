# This makefile constructs and compiles the C++ KBTree Library Swig interface for Java
# and Perl.  It is tested on Mac and Linux, and is not currently supported in Windows.
# Most build files are placed in the lib directory under the appropriate interface sub-
# directory.  Code that is actually edited is in the src directory (except for the .cxx files, which
# are src files generated by swig.  If you have Swig installed you can remake the swig files
# with "make swig" and "make clean-swig" commands.
# Otherwise, "make all" simply builds assuming the swig files are present, which is the
# advised building path because you do not have to install swig locally.
#
# Note that right now the Java Header Path for linux is hard coded to match the KBase-v10 Image.
#
# Also note that targets/prerequisites are not set properly, so everything will be remade each time
# a call is executed.  This is fine though because the build takes but a couple seconds.


# SET BASIC PATHS AND FILE NAMES WE WOULD LIKE TO USE
OUT_DIR := lib
SRC_PATH := src
SWIG_FILE := $(SRC_PATH)/kbtree.i
SWIG_PERL_WRAP_FILE := $(SRC_PATH)/kbtree_perl_wrap.cxx
SWIG_JAVA_WRAP_FILE := $(SRC_PATH)/kbtree_java_wrap.cxx

# NEEDED TO GET PATHS TO THE CORRECT JAVA INSTALL DIRECTORY - NOTE THAT WE ONLY SUPPORT COMPILING
# WITHIN THE KBASE ENVIRONMENT...
DEPLOY_RUNTIME ?= /kb/runtime
LOCAL_JAVA_SRC_DEPLOY_TARGET ?= ../../src
LOCAL_JAVA_LIB_DEPLOY_TARGET ?= ../../lib


# DETERMINE IF WE ARE MAC OR LINUX (this is clearly a hack, a better option would
# be to actually write a configure script)
UNAME := $(shell uname)

ifeq ($(UNAME),Darwin)
# not properly working in a mac env right now, so abort.
$(error trees server code does not currently support mac osx; you should deploy clients only)
#NOTE: you may have to change this architecture flag on some mac installs!
PERL_ARCH :=
PERL_CC_OPTIONS := $(shell /usr/bin/perl -MExtUtils::Embed -e ccopts)
PERL_LD_OPTIONS := $(shell /usr/bin/perl -MExtUtils::Embed -e ldopts)
PERL_LIB_CMD := $(PERL_ARCH) -bundle -o $(OUT_DIR)/perl_interface/TreeCppUtil.bundle
JAVA_HEADER_PATH := -I"$(shell javaconfig Headers)"
JAVA_LIB_CMD := -framework JavaVM -bundle -o $(OUT_DIR)/java_interface/libKBTreeUtil.jnilib
else ifeq ($(UNAME),Linux)
PERL_ARCH := 
PERL_CC_OPTIONS := $(shell perl -MConfig -e 'print join(" ", @Config{qw(ccflags optimize cccdlflags)}, "-I$$Config{archlib}/CORE")')
PERL_LD_OPTIONS := $(shell perl -MConfig -e 'print $$Config{lddlflags}')
PERL_LIB_CMD := -shared -o $(OUT_DIR)/perl_interface/TreeCppUtil.so
JAVA_HEADER_PATH := -I"$(DEPLOY_RUNTIME)/java/include/" -I"$(DEPLOY_RUNTIME)/java/include/linux/"
JAVA_LIB_CMD := -shared -o $(OUT_DIR)/java_interface/libKBTreeUtil.so
endif


.PHONY : clean

.PHONY : clean-swig

all: perl-lib


swig:
	mkdir -p $(OUT_DIR)/perl_interface/Bio/KBase/Tree
	swig -c++ -perl5 -module "Bio::KBase::Tree::TreeCppUtil" -outdir $(OUT_DIR)/perl_interface/ -o $(SWIG_PERL_WRAP_FILE) $(SWIG_FILE)
	mv $(OUT_DIR)/perl_interface/TreeCppUtil.pm $(OUT_DIR)/perl_interface/Bio/KBase/Tree/TreeCppUtil.pm
	swig -c++ -java -outdir $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil -package us.kbase.kbasetrees.cpputil -o $(SWIG_JAVA_WRAP_FILE) $(SWIG_FILE)

clean-swig:
	rm -f $(SWIG_PERL_WRAP_FILE)
	rm -f $(SWIG_JAVA_WRAP_FILE)
	rm -f $(OUT_DIR)/perl_interface/*.pm
	rm -f $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil/*.java


# this will always link, even if object files are built
perl-lib : $(OUT_DIR)/perl_interface/kbtree_wrap.o $(OUT_DIR)/perl_interface/kbtree.o
	g++ $(PERL_LIB_CMD) $(OUT_DIR)/perl_interface/kbtree_wrap.o $(OUT_DIR)/perl_interface/kbtree.o $(PERL_LD_OPTIONS)
$(OUT_DIR)/perl_interface/kbtree_wrap.o : $(SWIG_PERL_WRAP_FILE)
	g++ $(PERL_ARCH) -fpic -O3 -c $(SWIG_PERL_WRAP_FILE) $(PERL_CC_OPTIONS) -o $(OUT_DIR)/perl_interface/kbtree_wrap.o
$(OUT_DIR)/perl_interface/kbtree.o : $(SRC_PATH)/kbtree/kbtree.cpp
	g++ $(PERL_ARCH) -fpic -O3 -c $(SRC_PATH)/kbtree/kbtree.cpp -o $(OUT_DIR)/perl_interface/kbtree.o $(PERL_CC_OPTIONS)

# this will always link and compile, even if object files are built
java-lib : $(OUT_DIR)/java_interface/kbtree_wrap.o $(OUT_DIR)/java_interface/kbtree.o
	g++ $(JAVA_LIB_CMD) $(OUT_DIR)/java_interface/kbtree_wrap.o $(OUT_DIR)/java_interface/kbtree.o
	javac $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil/KBTreeUtilJNI.java $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil/KBTree.java $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil/KBTreeUtil.java
$(OUT_DIR)/java_interface/kbtree_wrap.o : $(SWIG_JAVA_WRAP_FILE)
	g++ -fpic -O3 -c $(SWIG_JAVA_WRAP_FILE) $(JAVA_HEADER_PATH) -o $(OUT_DIR)/java_interface/kbtree_wrap.o -fno-strict-aliasing
$(OUT_DIR)/java_interface/kbtree.o : $(SRC_PATH)/kbtree/kbtree.cpp
	g++ -fpic -O3 -c $(SRC_PATH)/kbtree/kbtree.cpp -o $(OUT_DIR)/java_interface/kbtree.o -fno-strict-aliasing

# copies java src and compiled libraries to the proper location
deploy-java :
	mkdir -p $(LOCAL_JAVA_SRC_DEPLOY_TARGET)/us/kbase/kbasetrees/cpputil
	cp lib/java_interface/us/kbase/kbasetrees/cpputil/KBTree.java $(LOCAL_JAVA_SRC_DEPLOY_TARGET)/us/kbase/kbasetrees/cpputil/.
	cp lib/java_interface/us/kbase/kbasetrees/cpputil/KBTreeUtil.java $(LOCAL_JAVA_SRC_DEPLOY_TARGET)/us/kbase/kbasetrees/cpputil/.
	cp lib/java_interface/us/kbase/kbasetrees/cpputil/KBTreeUtilJNI.java $(LOCAL_JAVA_SRC_DEPLOY_TARGET)/us/kbase/kbasetrees/cpputil/.
	cp lib/java_interface/libKBTreeUtil.* $(LOCAL_JAVA_LIB_DEPLOY_TARGET)

clean:
	rm -f $(OUT_DIR)/java_interface/*.jnilib $(OUT_DIR)/java_interface/*.o $(OUT_DIR)/java_interface/us/kbase/kbasetrees/cpputil/*.class 
	rm -f $(OUT_DIR)/java_interface/*.so
	rm -f $(OUT_DIR)/perl_interface/*.o $(OUT_DIR)/perl_interface/*.bundle $(OUT_DIR)/perl_interface/*.so